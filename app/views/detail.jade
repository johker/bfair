extends layout
block content
	script(src="/socket.io/socket.io.js")
	script(src='js/jquery-ui-1.10.2.custom.min.js')
	script(src='js/d3.v3.min.js')
	link(rel='stylesheet', href='css/detail.css')
	script(src='js/utils.js')
	include navbar
	.container
		.page-header
				h2 Market Detail
			p.lead
				form.form-inline
					.mid ID:
					.toa Total Available: 
					.ip In Play:  
				.row
					.span6
						.alert.alert-info
							.hpl0 
								strong Player 0
							.sid0 Selection ID: 
								strong
							.lpt0 Last Price Traded: 
								strong
							.tm0 Total Matched: 
								strong
						table#pl0book.table.table-bordered
							thead
								tr
									th Back 
									th Price
									th Lay	
							tbody
								tr#ob1
									td#back 
									td#price &nbsp;
									td#lay
								tr#ob2
									td#back
									td#price &nbsp;
									td#lay
								tr#ob3
									td#back
									td#price &nbsp; 
									td#lay
								tr#ob4
									td#back
									td#price &nbsp;
									td#lay
								tr#ob5
									td#back
									td#price &nbsp;
									td#lay
								tr#ob6
									td#back
									td#price &nbsp;
									td#lay
					.span6
						.alert.alert-info
							.hpl1 
								strong Player 1
							.sid1 Selection ID: 
								strong
							.lpt1 Last Price Traded: 
								strong
							.tm1 Total Matched: 
								strong
						table#pl1book.table.table-bordered
							thead
								tr
									th Back
									th Price
									th Lay	
							tbody
								tr#ob1
									td#back 
									td#price &nbsp;
									td#lay
								tr#ob2
									td#back
									td#price &nbsp;
									td#lay
								tr#ob3
									td#back
									td#price &nbsp; 
									td#lay
								tr#ob4
									td#back
									td#price &nbsp;
									td#lay
								tr#ob5
									td#back
									td#price &nbsp;
									td#lay
								tr#ob6
									td#back
									td#price &nbsp;
									td#lay
				.row
					.span6
						form#backform(method='post', action='/markets')
							button.btn.btn-primary.btn-mini(type='submit') Back
				.row
					.span12
						form#orderform 	
							fieldset
								legend Orders
								include messages									
								.form-group
									label(for="runnerselect") Selection ID
									select#idselect(name="accountId") 
								.form-group
									label(for="sizeselect") Size
									input#sizeselect(type="text", placeholder="Size")
								.form-group
									label(for="priceselect") Price
									input#priceselect(type="text", placeholder="Price")
								.form-group
									label(for="sideselect") Side
									select#sideselect  
										option(value="BACK") BACK
										option(value="LAY") LAY
								.form-group
									label(for="typeselect") Order Type
									select#typeselect
										option(value="LIMIT") LIMIT
										option(value="LIMIT_ON_CLOSE") LIMIT_ON_CLOSE
										option(value="MARKET_ON_CLOSE") MARKET_ON_CLOSE
							button#execute.btn.btn-primary.btn-mini(type='button') Execute
					script
						io = io.connect();
						io.on('tick_' + #{id},function(data){
							$('.mid').text('ID: ' + data.marketId);
							$('.toa').text('Total Available: ' + data.totalAvailable);
							$('.ip').text('In Play: ' + data.inplay);
							$('.hpl0 strong').text('#{pl0}'); 
							$('.hpl1 strong').text('#{pl1}'); 
							assign(data);
						});
						function assign(data) {
							for ( var pIdx = 0; pIdx < data.runners.length; ++pIdx) {
								var runner = data.runners[pIdx];								
								if($('#idselect option').size() < 2) {
									$('#idselect').append(new Option(runner.selectionId,runner.selectionId));
								}
								$('.sid' + pIdx + ' strong').text(runner.selectionId);
								$('.lpt' + pIdx + ' strong').text(runner.lastPriceTraded);
								$('.tm' + pIdx + ' strong').text(runner.totalMatched);							
								var atb = data.runners[pIdx].ex.availableToBack;
								for(var bIdx = 0; bIdx < atb.length; bIdx++) {
									setAndHighlight('pl' + pIdx + 'book tbody tr#ob' + (bIdx+4) + ' td#back', atb[bIdx].size);									
									setAndHighlight('pl' + pIdx + 'book tbody tr#ob' + (bIdx+4) + ' td#price', atb[bIdx].price);
								}					
								var atl = data.runners[pIdx].ex.availableToLay;	
								for(var lIdx = 0; lIdx < atl.length; lIdx++) {									
									setAndHighlight('pl' + pIdx + 'book tbody tr#ob' + (atl.length-lIdx) + ' td#lay', atl[lIdx].size);									
									setAndHighlight('pl' + pIdx + 'book tbody tr#ob' + (atl.length-lIdx) + ' td#price', atl[lIdx].price);
								}
								
							}
						}	
						$('#execute').click(function(e) {
							validate(e.target.id);
						});
						$("#close-alerts").click(function(e) {
							e.preventDefault();
							$('#erritems li').remove();
							$('#errmsg').hide();						
						});
						$("#close-confirmation").click(function(e) {
							e.preventDefault();
							$('#confcontent li').remove();
							$('#confmsg').hide();						
						});
						function validate(target) {
							$.ajax({
							url: '/validateorder',
							type: 'POST',
							cache: false,
							data: {
								price: $('#priceselect').val(), 
								size: $('#sizeselect').val(),
								sid: $('#idselect :selected').val(),
								type: $('#typeselect :selected').val(),
								side: $('#sideselect :selected').val(),
								operation: target
							},
							success: function(data){
								resetMessages();								
								if(data.errorTitle == undefined) { 
									setConfirmationMessages(data.conftitle, data.confcontent);
									$('#confmsg').show();
									$('#errmsg').hide();								
									
								} else {
									setErrorMessages(data.errorTitle, data.errors);
									$('#confmsg').hide();
									$('#errmsg').show();
								}																			
							}
							, error: function(jqXHR, textStatus, err){
								alert(err);
								}
							})
						}
						function execute() {
							$.ajax({
							url: '/executeorder',
							type: 'POST',
							cache: false,
							data: {eventId: $('#eventId').val(), startDate: $('#startDate').val(), endDate: $('#endDate').val()},
							success: function(data){
								resetMessages();
								setValues(data.eventId, data.startDate, data.endDate);
								setConfirmationMessages(data.msgTitle, data.msgContent);
								$('#confmsg').show();														
							}
							, error: function(jqXHR, textStatus, err){
								alert(err);
								}
							})
						
						}