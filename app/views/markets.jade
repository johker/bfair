extends layout

block content
	script(src="/socket.io/socket.io.js")
	script(src='js/jquery-ui-1.10.2.custom.min.js')
	script(src='js/utils.js')
	include navbar
	.container
		.page-header
			h2 Market Monitoring
		p.lead
			form#viewhistory(method='post', action='/history')
				.alert.alert-info
					.actct Active: 
						strong
					.logct Logged: 
						strong
					.hist Show table of closed markets tagged for logging: 
						button.btn.btn-primary.btn-mini(type='submit') History
			form#viewdetail(method='post', action='/detail')        
				table#idtable.table.table-bordered
					thead
						tr
							th Market ID 
							th Type
							th Activation Time
							th Date
							th Detail
							th Prices
					tbody
					script
						io = io.connect();
						io.emit('marketsready');
						io.on('addmarket',function(data){
							var activationTime = typeof data.activationTime === 'undefined' ? 'Undefined' : '' + millisToDate(data.activationTime);
							var mid = data.marketId.substring(2,data.marketId.length);							
								$('#idtable tbody').append('<tr id="'+ data.marketId.substring(2,data.marketId.length) +'" class="trmarket">'
									+ '<td class="mid">' + mid + '</td>'									
									+ '<td class="mn">' + data.marketName + '</td>'
									+ '<td class="mat">' + activationTime + '</td>'
									+ '<td class="mt">' + data.event.openDate + '</td>'
									+ '<td class="md">' + data.event.name + '</td>'
									+ '<td class="mpl"></td>'
									+ '</tr>');		
								$('#' + mid + ' td.mpl').append('<button class="btn btn-primary btn-mini" id="' + mid + '" onClick="reply_click(this.id)" type="submit">Detail</button>');  					
							});
							io.on('updatecounters', function(data) {
								$('.actct strong').text(data.active);
								$('.logct strong').text(data.logged);
							});
							io.on('updatemarket',function(data){	
									var mid = data.marketId.substring(2,data.marketId.length);	
									console.log('updatemarket');							
									$('#' + mid + ' td.mid')
											.animate( { backgroundColor: "#E6E6E6" }, 750 )
											.animate( { backgroundColor: "transparent" }, 750 );														
									setAndHighlight('' + data.marketId + ' td.mtm', data.totalMatched);
							});		
							io.on('removemarket', function(data) {	
								var mid = data.marketId.substring(2,data.marketId.length);	
								$('#' + mid)
									.animate( { backgroundColor: "#E6E6E6" }, 750 )
									.animate( { backgroundColor: "transparent" }, 750 );
								setTimeout(function(){
									$('#' + data.marketId).remove()}, 1000);
							});
							$("#viewdetail").click(function(e) {
								io.emit('viewprdetail', {marketId: e.target.id});
							});		